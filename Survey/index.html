<!DOCTYPE html>
<html>
  <body>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.8.2/firebase.js"></script>

    <script>
      // Your web app's Firebase configuration
      var firebaseConfig = {
        apiKey: "AIzaSyCOZEE8Q7lkClwEl9Qwv57YkSd6g8zoFio",
        authDomain: "redirectcounter.firebaseapp.com",
        databaseURL: "https://redirectcounter.firebaseio.com",
        projectId: "redirectcounter",
        storageBucket: "redirectcounter.appspot.com",
        messagingSenderId: "913532184722",
        appId: "1:913532184722:web:b5c1562360097c48e11e4b",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      let webpages = [
        "https://www.surveycake.com/s/4QDRQ",
        "https://www.surveycake.com/s/yBBXw",
        "https://www.surveycake.com/s/AllvP",
      ];

      let database = firebase.database();

      let root_ref = database.ref(`/`);
      let first_ref = root_ref.child("first");
      let second_ref = root_ref.child("second");
      let third_ref = root_ref.child("third");
      let limit = 0;

      root_ref.once("value").then(function (snapshot) {
        let value = snapshot.val();
        limit = value.Limit;

        let pages = [
          { 0: value.first },
          { 1: value.second },
          { 2: value.third },
        ].filter((page) => Object.values(page)[0] < limit);

        let refs = [first_ref, second_ref, third_ref];
        let random_page = Math.floor(Math.random() * pages.length);

        page = pages[random_page];
        let index = parseInt(Object.keys(page)[0], 10);
        refs[index].transaction(function (value) {
          return (value || 0) + 1;
        });
        setTimeout(function () {
          window.location.href = webpages[index];
        }, 100);
      });
    </script>
  </body>
</html>
